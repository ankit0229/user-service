# User Management System

## Description

This FastAPI application is designed to manage user registration, login, and profile updates, utilizing PostgreSQL for data storage and JWT for secure authentication.

## Features

- **User Registration**: Allows new users to sign up with their email, name, and password.
- **User Login**: Users can log in using their email and password to obtain a bearer token.
- **View User Profile**: Authenticated users can view their profile details by providing the bearer token in the request headers.
- **Update User Profile**: Users can update their profiles, specifically their address and date of birth, using a bearer token for authentication.
- **JWT Authentication**: Passwords are hashed and stored securely. Upon successful login, a JWT token is generated by encoding the user ID with a secret key.
- **Middleware for Route Protection**: The application uses middleware to ensure that all routes, except whitelisted ones, require authentication. The user ID is retrieved from the token.

## Tech Stack

- **FastAPI**
- **PostgreSQL**
- **Docker**
- **Uvicorn**

## Running the Server

The service is fully dockerized, including PostgreSQL and PGAdmin. The `run.sh` file contains commands to build and run the containers seamlessly.

### Prerequisites

Ensure you have Docker and Docker Compose installed on your machine to run the application containers.

```bash
# Install Docker
https://docs.docker.com/get-docker/

# Install Docker Compose
https://docs.docker.com/compose/install/
```

### Commands to run the server
Navigate to the project directory and execute the provided shell script to start the server:

```bash
./run.sh
```



Right now there is some issue with the `alembic upgrade head` due to which the tables are not getting 
created form the generated migration files. So, need to create tables manually using DB queries using below steps:
1. Find the running PostgreSQL Container
```bash
docker ps
```

2. Access the POostgresSQL shell
```bash
docker exec -it user-service-db-1 psql -U postgres
```

3. List databases
```bash
\l
```

4. Switch to a database
```bash
\c user_db
```
5. Run the below queries

```bash
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR NOT NULL UNIQUE,
    name VARCHAR NOT NULL,
    hashed_password VARCHAR NOT NULL,
    address VARCHAR,
    date_of_birth VARCHAR,
    dt_created TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    dt_updated TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
  
```


```bash
CREATE OR REPLACE FUNCTION update_modified_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.dt_updated = now(); 
    RETURN NEW; 
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_modtime
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();
```
This script builds and runs the docker containers for the PostgreSQL database, PGAdmin, and the FastAPI application.

### API Documentation
The API documentation can be accessed via Swagger UI using the following URL once the server is up:
```bash
http://localhost:8000/docs#/
```
The Postman collection named `user_service_collection.json` is also included in the repository.